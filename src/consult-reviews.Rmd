---
title: ''
author: "null"
output:
  html_document: default
params:
  dt_start:
    label: "Start Date"
    input: date
    value: !r lubridate::floor_date((Sys.Date()-90), "quarter")
    max: !r Sys.Date()
  dt_end: 
    label: "End Date"
    input: date
    value: !r lubridate::ceiling_date((Sys.Date()-90), "quarter")-1
    max: !r Sys.Date()
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(root.dir = "..")
```

```{r load_libraries}
library(gt)
library(here)
library(lubridate)
library(readxl)
library(tidyverse)

# Import functions --------------------------------------------------------
source(here("fns", "define-clients.R"))
```

<div align="center"> 

![](sp-logo.png){width=25%}

## Consultations for Review

### Reporting Period: `r {lubridate::year(params$dt_start)}` Quarter `r {lubridate::quarter(params$dt_start)}` 

<br><br>

```{r import-clean-data, include=FALSE}
# internal consultation data ----------------------------------------------
consult_int <- 
  list.files(path = here("data"),
             pattern = "(\\d){4}\\D\\d-int\\.xls",
             full.names = TRUE 
  ) %>% 
  sapply(read_excel, simplify = FALSE) %>% 
  bind_rows() %>% 
  mutate(
    `Collected date` = mdy(`Collected date`),
    `Sequence Group` = str_replace(`Sequence Group`, "\\*SURG", "SURG"),
    `Sequence Group` = str_replace(`Sequence Group`, "OP SURG", "SURG OP"),
    `Sequence Group` = str_replace(`Sequence Group`, "OP NGYN", "NGYN OP"),
    type = str_extract(`Sequence Group`, "()[^(]+") %>% str_trim(),
    client = str_extract(`Sequence Group`, "(?<=\\().*?(?=\\))"),
    grp = client_abbr(`Sequence Group`),
    cl_grp = client_group(`Sequence Group`),
    `Consulting Pathologist` = str_extract(`Consulting Pathologist`, ".+?(?=,)")
  ) %>% 
  select(`Collected date`, 
         `Result ID`, 
         `Primary Pathologist`,
         `Consulting Pathologist`,
         cl_grp,
         Correlation
  ) %>% 
  rename(Client = cl_grp)

# external consultation data ----------------------------------------------
consult_ext <- 
  list.files(path = here("data"),
             pattern = "(\\d){4}\\D\\d-ext\\.xls",
             full.names = TRUE 
  ) %>% 
  sapply(read_excel, simplify = FALSE) %>% 
  bind_rows() %>% 
  mutate(
    `Collected date` = mdy(`Collected date`),
    `Sequence Group` = str_replace(`Sequence Group`, "\\*SURG", "SURG"),
    `Sequence Group` = str_replace(`Sequence Group`, "OP SURG", "SURG OP"),
    `Sequence Group` = str_replace(`Sequence Group`, "OP NGYN", "NGYN OP"),
    type = str_extract(`Sequence Group`, "()[^(]+") %>% str_trim(),
    client = str_extract(`Sequence Group`, "(?<=\\().*?(?=\\))"),
    grp = client_abbr(`Sequence Group`),
    cl_grp = client_group(`Sequence Group`)
  ) %>% 
  select(`Collected date`, 
         `Result ID`, 
         `Primary Pathologist`, 
         cl_grp,
         Correlation
  ) %>% 
  rename(Client = cl_grp)

# intraoperative consultation data ----------------------------------------
consult_iop <- 
  list.files(path = here("data"),
             pattern = "(\\d){4}\\D\\d-iop\\.xls",
             full.names = TRUE 
  ) %>% 
  sapply(read_excel, simplify = FALSE) %>% 
  bind_rows() %>% 
  mutate(
    `Collected date` = mdy(`Collected date`),
    `Sequence Group` = str_replace(`Sequence Group`, "\\*SURG", "SURG"),
    `Sequence Group` = str_replace(`Sequence Group`, "OP SURG", "SURG OP"),
    `Sequence Group` = str_replace(`Sequence Group`, "OP NGYN", "NGYN OP"),
    type = str_extract(`Sequence Group`, "()[^(]+") %>% str_trim(),
    client = str_extract(`Sequence Group`, "(?<=\\().*?(?=\\))"),
    grp = client_abbr(`Sequence Group`),
    cl_grp = client_group(`Sequence Group`)
  ) %>% 
  select(`Collected date`, 
         `Result ID`, 
         `IntraOp Path`, 
         cl_grp,
         Correlation
  ) %>% 
  rename(Client = cl_grp, `Primary Pathologist` = `IntraOp Path`)

```

```{r consults-to-review, include=FALSE}
consult_review <- 
  consult_ext %>% 
  bind_rows(consult_int) %>% 
  bind_rows(consult_iop) %>% 
  filter(as_date(`Collected date`) >= params$dt_start & 
           as_date(`Collected date`) <= params$dt_end, 
         Correlation != "YES" & 
           Correlation != "Select" & 
           Correlation != "NA",
         Client != "Summit Pathology Outpatient") %>% 
  arrange(Client, `Primary Pathologist`)
```

```{r review-table, warning=FALSE}
consult_review %>% 
  gt(rowname_col = "Primary Pathologist", groupname_col = "Client")
```


