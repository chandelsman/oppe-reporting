---
title: ''
author: 'null'
output:
  # pdf_document: default
  html_document: default
params:
  # cl_grp:
  #   # - Sheridan
  #   # - UCHealth North
  #   choices:
  #   - Centers for Gastroenterology
  #   - Estes Park Health Hospital
  #   - Grandview Hospital
  #   - Ivinson Memorial Hospital
  #   - Melissa Memorial Hospital
  #   - Memorial Hospital of Carbon County
  #   - Memorial Hospital Central
  #   - Memorial Hospital North
  #   - Pikes Peak Regional Hospital
  #   - Summit Pathology Outreach
  #   - Wyoming Veterans Administration
  #   input: select
  #   label: Client Group
  #   value: Ivinson Memorial Hospital
  dt_start:
    label: Start Date
    input: date
    value: !r lubridate::floor_date((Sys.Date()-90), "quarter")
    max: !r Sys.Date()
  dt_end:
    label: End Date
    input: date
    value: !r lubridate::ceiling_date((Sys.Date()-90), "quarter")-1
    max: !r Sys.Date()
editor_options:
  chunk_output_type: console
---

```{r overview, include = FALSE, message = FALSE, warning = FALSE}
# This script produces quarterly OPPE reports for client groups as 
# specified in the YAML header. Turnaround time by client group, facility, 
# and pathologist is calculated overall and subsequently broken down by 
# surgical and non-gyn case types. Consultations are counted and presented 
# by outcome (agree, disagree, etc.) for internal, external, and 
# intraoperative consultations. 
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load_libraries, message = FALSE, warning = FALSE}
library(difftimeOffice)
library(gt)
library(here)
library(readxl)
library(tidyverse)
```

```{r load-functions, message = FALSE, warning = FALSE}
# Import functions --------------------------------------------------------
# Standardize client names and abbreviations
source(here("fns", "define-clients.R"))
```

```{r load_data, message = FALSE, warning = FALSE}
### Import raw data -----
# Turnaround time data ---------------------------------------------------
ta_time_raw <-
  list.files(
    path = here("data"),
    pattern = "(\\d){4}-q(\\d){1}_tat.*\\.xls",
    full.names = TRUE
  ) |>
  sapply(
    read_excel,
    simplify = FALSE,
    col_types =
      c(
        "guess",
        "guess",
        "guess",
        "numeric",
        "text",
        "guess",
        "guess",
        "guess",
        "guess",
        "guess",
        "guess",
        "guess"
      )
  ) |>
  bind_rows()
```


```{r turnaround time, message = FALSE, warning = FALSE}
# Clean turnaround time data ----------------------------------------------

# make columns for case type: ngyn, surg, ngyn outpatient, surg outpatient
# reformat dates to POSIXct 
# define client groups
# drop deleted cases

ta_time <- 
  ta_time_raw |>
  rename(`Sequence Group` = `SEQUENCE GROUP`) |>
  mutate(
    `Sequence Group` = str_replace(`Sequence Group`, "\\*SURG", "SURG"),
    `Sequence Group` = str_replace(`Sequence Group`, "OP SURG", "SURG OP"),
    `Sequence Group` = str_replace(`Sequence Group`, "OP NGYN", "NGYN OP"),
    PATHOLOGIST = str_replace(PATHOLOGIST, "\\[x] ", ""),
    type = str_extract(`Sequence Group`, "()[^(]+") |> str_trim(),
    client = str_extract(`Sequence Group`, "(?<=\\().*?(?=\\))"),
    client = gsub("WOODLAND", "PPRH", client),
    Create = as_datetime(parse_date_time(Create, c("mdy HM", "mdy HMS"))),
    `original release` = mdy_hm(`original release`),
    grp = client_abbr(`Sequence Group`),
    cl_grp = client_group(`Sequence Group`)
  ) |>
  filter(
    STATUS == "Completed",
    !is.na(`original release`),
    as_date(Create) >= params$dt_start &
      as_date(Create) <= params$dt_end,
    !is.na(PATHOLOGIST),
    # cl_grp == params$cl_grp
  ) # drop deleted records
```

```{r calculate turnaround time, message = FALSE, warning = FALSE}

# Turnaround time function ------------------------------------------------
# function to calculate time from case created to initial release
#   exclude weekends and holidays from time calculations
#   holidays: New Years, Memorial Day, Labor Day, 
#             Independence Day, Thanksgiving, Christmas

ta_time$span <-
  sapply(1:nrow(ta_time), function(x) {
    difftime_office_hours(
      started = ta_time$Create[x],
      ended = ta_time$`original release`[x],
      working_hours = c(0, 24),
      holidays =
        c(
          "2022-01-03",
          "2022-05-30",
          "2022-07-04",
          "2022-09-05",
          "2022-11-24",
          "2022-12-26",
          "2023-01-02",
          "2023-05-29",
          "2023-07-04",
          "2023-09-04",
          "2023-11-23",
          "2023-12-25"
        )
    )
  })

# Convert elapsed time from seconds to hours 
ta_time$span <- ta_time$span / 3600 
```

<div align="center"> 

![](sp-logo.png){width=25%}

# **Turnaround Time Report**

# **Centrum Surgery Center**

## **`r params$dt_start` â€“ `r params$dt_end`** 

<br><br>

<div style = "text-align: center">

## Overall Turnaround Time

</div>


```{r tat_table_group, message = FALSE, warning = FALSE}

ta_time |>
  summarize(
    Cases = n(),
    Average = mean(span),
    `Under 48 hrs` = sum(span <= 48) / n()
  ) |>
  gt(auto_align = TRUE) |>
  tab_header(title = "",
              subtitle = "") |>
  fmt_number(columns = c(Cases),
             decimals = 0,
             use_seps = TRUE) |>
  fmt_number(columns = c(Average),
             decimals = 1,
             use_seps = TRUE) |>
  fmt_percent(
    columns = c(`Under 48 hrs`),
    decimals = 1,
    use_seps = T
  ) |>
  sub_missing(
    columns = everything(),
    missing_text = "---"
  ) |> 
  cols_label(
    Average = "Avg Time (hrs)"
  ) |> 
  cols_align(align = "right") |> 
  tab_options(table.width = pct(65),
              column_labels.font.weight = "bolder",
              heading.title.font.weight = "bolder",
              heading.title.font.size = pct(120)
  )
```

<br>

```{r tat_table_group_filtered, message = FALSE, warning = FALSE}

ta_time |>
  filter(!(str_detect(CPTS, "88311|88341|88342"))) |>
  summarize(
    Cases = n(),
    Average = mean(span),
    `Under 48 hrs` = sum(span <= 48) / n()
  ) |>
  gt(auto_align = TRUE) |>
  tab_header(title = md("*CPT codes 88311, 88341, and 88342 **excluded***"),
              subtitle = "") |>
  fmt_number(columns = c(Cases),
             decimals = 0,
             use_seps = TRUE) |>
  fmt_number(columns = c(Average),
             decimals = 1,
             use_seps = TRUE) |>
  fmt_percent(
    columns = c(`Under 48 hrs`),
    decimals = 1,
    use_seps = T
  ) |>
  sub_missing(
    columns = everything(),
    missing_text = "---"
  ) |> 
    cols_label(
    Average = "Avg Time (hrs)"
  ) |> 
  cols_align(align = "right") |>
  tab_footnote(
    footnote = md("*Turnaround time excludes cases where tissue 
    decalcification or IHC stains were performed*"),
    locations = cells_title()
  ) |> 
  tab_options(table.width = pct(65),
              column_labels.font.weight = "bolder",
              heading.title.font.weight = "bolder",
              heading.title.font.size = pct(120)
  )
```

<br>

<div style = "page-break-before: auto">
  <div style = "text-align: center"> 

## Turnaround Time by Pathologist 

  </div>
</div>

```{r tat_table_pathologist, message = FALSE, warning = FALSE}

ta_time |>
  group_by(PATHOLOGIST) |>
  summarize(
    Cases = n(),
    Average = mean(span),
    `Under 48 hrs` = sum(span <= 48) / n()
  ) |>
  gt(rowname_col = "PATHOLOGIST") |>
  tab_header(title = "",
              subtitle = "") |>
  fmt_number(columns = (Cases),
             decimals = 0,
             use_seps = TRUE) |>
  fmt_number(columns = (Average),
             decimals = 1,
             use_seps = TRUE) |>
  fmt_percent(
    columns = (`Under 48 hrs`),
    decimals = 1,
    use_seps = T
  ) |>
  sub_missing(
    columns = everything(),
    missing_text = "---"
  ) |> 
  cols_label(Average = "Avg Time (hrs)",
             Cases = "n") |>
  cols_align(align = "left",
             columns = "PATHOLOGIST") |>
  tab_options(
    summary_row.padding = px(2),
    row_group.font.weight = "bold",
    row_group.padding = px(8),
    column_labels.font.weight = "bold",
    table.width = pct(75)
  )
```
